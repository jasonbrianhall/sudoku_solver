name: Build Sudoku

on:
  push:
    branches: [ master, dev ]
  pull_request:
    branches: [ master, dev ]
  workflow_dispatch:

env:
  PRODUCT_VERSION: "1.0.${{ github.run_number }}"
  UPGRADE_CODE: "E1A85D73-9B2C-4E6D-B3C1-8F0A9D2E5C7B"

jobs:
  build-msdos:
    runs-on: ubuntu-latest
    container: 
      image: djfdyuruiry/djgpp
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        apt-get update
        apt-get install -y wget unzip zip

    - name: Download CSDPMI
      working-directory: msdos
      run: |
        wget http://na.mirror.garr.it/mirrors/djgpp/current/v2misc/csdpmi7b.zip
        unzip -o csdpmi7b.zip -d csdpmi

    - name: Build MS-DOS Version
      working-directory: msdos
      run: |
        cp ../shared/*.cpp .
        cp ../shared/*.h .
        g++ dosprint.cpp generatepuzzle.cpp msdos_main.cpp sudoku.cpp -o sudoku.exe
        exe2coff sudoku.exe
        cat csdpmi/bin/CWSDSTUB.EXE sudoku > sudoku.exe
        
    - name: Create MS-DOS Distribution
      working-directory: msdos
      run: |
        mkdir sudoku-msdos-v1.0
        cp sudoku.exe sudoku-msdos-v1.0/
        cp ../README.md sudoku-msdos-v1.0/
        cp ../LICENSE.md sudoku-msdos-v1.0/
        
        echo "Sudoku Solver for MS-DOS
        Version 1.0

        Installation:
        1. dosbox sudoku.exe

        Requirements:
        - MS-DOS or compatible OS
        - 4MB RAM
        - VGA or better graphics" > sudoku-msdos-v1.0/README-MSDOS.txt
        
        zip -r ../Sudoku-MSDOS.zip sudoku-msdos-v1.0

    - name: Upload MS-DOS Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: msdos-artifacts
        path: |
          Sudoku-MSDOS.zip

  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    outputs:
      version: ${{ env.PRODUCT_VERSION }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.3.1
      
    - name: Setup Developer Command Prompt
      uses: ilammy/msvc-dev-cmd@v1

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install Python dependencies
      working-directory: python_generate_puzzles
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller pybind11

    - name: Build C++ Executable
      working-directory: windows
      run: |
        msbuild /p:Configuration=Release /p:Platform=x64 SudokuSolver.vcxproj

    - name: Build Python Extension
      working-directory: python_generate_puzzles
      run: |
        python setup.py build_ext --inplace --force

    - name: Create PyInstaller Spec for QT5 Solver
      working-directory: python_generate_puzzles
      shell: cmd
      run: |
        echo # -*- mode: python ; coding: utf-8 -*- > sudoku_solver.spec
        echo. >> sudoku_solver.spec
        echo block_cipher = None >> sudoku_solver.spec
        echo. >> sudoku_solver.spec
        echo a = Analysis^( >> sudoku_solver.spec
        echo     ['sudoku_game_qt5.py'], >> sudoku_solver.spec
        echo     pathex=[], >> sudoku_solver.spec
        echo     binaries=[], >> sudoku_solver.spec
        echo     datas=[], >> sudoku_solver.spec
        echo     hiddenimports=['PyQt5.sip'], >> sudoku_solver.spec
        echo     hookspath=[], >> sudoku_solver.spec
        echo     runtime_hooks=[], >> sudoku_solver.spec
        echo     excludes=[], >> sudoku_solver.spec
        echo     win_no_prefer_redirects=False, >> sudoku_solver.spec
        echo     win_private_assemblies=False, >> sudoku_solver.spec
        echo     cipher=block_cipher, >> sudoku_solver.spec
        echo     noarchive=False, >> sudoku_solver.spec
        echo ^) >> sudoku_solver.spec
        echo. >> sudoku_solver.spec
        echo a.binaries += [('sudoku_solver.pyd', './sudoku_solver.pyd', 'BINARY')] >> sudoku_solver.spec
        echo. >> sudoku_solver.spec
        echo pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher) >> sudoku_solver.spec
        echo. >> sudoku_solver.spec
        echo exe = EXE^( >> sudoku_solver.spec
        echo     pyz, >> sudoku_solver.spec
        echo     a.scripts, >> sudoku_solver.spec
        echo     a.binaries, >> sudoku_solver.spec
        echo     a.zipfiles, >> sudoku_solver.spec
        echo     a.datas, >> sudoku_solver.spec
        echo     [], >> sudoku_solver.spec
        echo     name='SudokuSolver', >> sudoku_solver.spec
        echo     debug=False, >> sudoku_solver.spec
        echo     bootloader_ignore_signals=False, >> sudoku_solver.spec
        echo     strip=False, >> sudoku_solver.spec
        echo     upx=True, >> sudoku_solver.spec
        echo     upx_exclude=[], >> sudoku_solver.spec
        echo     runtime_tmpdir=None, >> sudoku_solver.spec
        echo     console=False, >> sudoku_solver.spec
        echo     disable_windowed_traceback=False, >> sudoku_solver.spec
        echo     target_arch=None, >> sudoku_solver.spec
        echo     codesign_identity=None, >> sudoku_solver.spec
        echo     entitlements_file=None, >> sudoku_solver.spec
        echo ^) >> sudoku_solver.spec

    - name: Build Python Executable for Solver
      working-directory: python_generate_puzzles
      run: |
        pyinstaller --clean sudoku_solver.spec

    - name: Create PyInstaller Spec for QT5 Game
      working-directory: python_generate_puzzles
      shell: cmd
      run: |
        echo # -*- mode: python ; coding: utf-8 -*- > sudoku_game.spec
        echo. >> sudoku_game.spec
        echo block_cipher = None >> sudoku_game.spec
        echo. >> sudoku_game.spec
        echo a = Analysis^( >> sudoku_game.spec
        echo     ['sudoku_player_qt5.py'], >> sudoku_game.spec
        echo     pathex=[], >> sudoku_game.spec
        echo     binaries=[], >> sudoku_game.spec
        echo     datas=[], >> sudoku_game.spec
        echo     hiddenimports=['PyQt5.sip'], >> sudoku_game.spec
        echo     hookspath=[], >> sudoku_game.spec
        echo     runtime_hooks=[], >> sudoku_game.spec
        echo     excludes=[], >> sudoku_game.spec
        echo     win_no_prefer_redirects=False, >> sudoku_game.spec
        echo     win_private_assemblies=False, >> sudoku_game.spec
        echo     cipher=block_cipher, >> sudoku_game.spec
        echo     noarchive=False, >> sudoku_game.spec
        echo ^) >> sudoku_game.spec
        echo. >> sudoku_game.spec
        echo a.binaries += [('sudoku_solver.pyd', './sudoku_solver.pyd', 'BINARY')] >> sudoku_game.spec
        echo. >> sudoku_game.spec
        echo pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher) >> sudoku_game.spec
        echo. >> sudoku_game.spec
        echo exe = EXE^( >> sudoku_game.spec
        echo     pyz, >> sudoku_game.spec
        echo     a.scripts, >> sudoku_game.spec
        echo     a.binaries, >> sudoku_game.spec
        echo     a.zipfiles, >> sudoku_game.spec
        echo     a.datas, >> sudoku_game.spec
        echo     [], >> sudoku_game.spec
        echo     name='SudokuPuzzler', >> sudoku_game.spec
        echo     debug=False, >> sudoku_game.spec
        echo     bootloader_ignore_signals=False, >> sudoku_game.spec
        echo     strip=False, >> sudoku_game.spec
        echo     upx=True, >> sudoku_game.spec
        echo     upx_exclude=[], >> sudoku_game.spec
        echo     runtime_tmpdir=None, >> sudoku_game.spec
        echo     console=False, >> sudoku_game.spec
        echo     disable_windowed_traceback=False, >> sudoku_game.spec
        echo     target_arch=None, >> sudoku_game.spec
        echo     codesign_identity=None, >> sudoku_game.spec
        echo     entitlements_file=None, >> sudoku_game.spec
        echo ^) >> sudoku_game.spec

    - name: Build Python Executable for Game
      working-directory: python_generate_puzzles
      run: |
        pyinstaller --clean sudoku_game.spec

    - name: Convert Icon
      run: |
        $imageMagick = "C:\Program Files\ImageMagick-7.1.2-Q16-HDRI\magick.exe"
        if (-not (Test-Path $imageMagick)) {
          Write-Host "ImageMagick not found, installing..."
          choco install imagemagick.tool -y
          $imageMagick = "C:\Program Files\ImageMagick-7.1.2-Q16-HDRI\magick.exe"
        }
        & $imageMagick convert "windows/appicon.jpg" -resize 256x256 "windows/appicon.ico"
        Write-Host "Icon converted successfully"

    - name: Prepare MSI Build Directory
      run: |
        $buildDir = "artifacts/build/windows"
        New-Item -ItemType Directory -Path $buildDir -Force | Out-Null
        
        # Copy executables
        Copy-Item "windows/x64/Release/SudokuSolver.exe" $buildDir/ -ErrorAction SilentlyContinue
        Copy-Item "python_generate_puzzles/dist/SudokuSolver.exe" "$buildDir/SudokuSolver-PyQT5.exe" -ErrorAction SilentlyContinue
        Copy-Item "python_generate_puzzles/dist/SudokuPuzzler.exe" $buildDir/ -ErrorAction SilentlyContinue
        
        # Copy documentation
        Copy-Item "README.md" $buildDir/ -ErrorAction SilentlyContinue
        Copy-Item "LICENSE.md" $buildDir/ -ErrorAction SilentlyContinue
        
        # Copy icons
        Copy-Item "windows/appicon.ico" $buildDir/ -ErrorAction SilentlyContinue
        Copy-Item "windows/appicon.jpg" $buildDir/ -ErrorAction SilentlyContinue
        
        Write-Host "Build directory prepared"
        Get-ChildItem $buildDir

    - name: Generate MSI Installer
      working-directory: artifacts/build/windows
      shell: powershell
      run: |
        Write-Host "=== Generating MSI Installer WiX ===" 
        
        $files = Get-ChildItem -File | Where-Object { $_.Name -ne "installer.wxs" } | Sort-Object Name
        
        Write-Host "Files to include in MSI:"
        $files | ForEach-Object { Write-Host "  - $($_.Name)" }
        
        $fileComponents = @()
        $componentRefs = @()
        
        foreach ($file in $files) {
          $safeName = $file.Name -replace '\.', '_' -replace '-', '_'
          $component = '                  <Component Id="Comp_{0}" Guid="{1}" Win64="yes">' -f $safeName, (New-Guid)
          $component += "`n"
          $component += '                    <File Id="File_{0}" Source="$(var.SourceDir)\{1}" KeyPath="yes" />' -f $safeName, $file.Name
          $component += "`n"
          $component += '                  </Component>'
          $fileComponents += $component
          $ref = '        <ComponentRef Id="Comp_{0}" />' -f $safeName
          $componentRefs += $ref
        }
        
        # Build the complete WiX installer using array of lines
        $wxsLines = @(
          '<?xml version="1.0" encoding="UTF-8"?>'
          '<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">'
          '  <Product Id="*"'
          '           Name="Sudoku Solvers"'
          '           Language="1033"'
          '           Version="${{ env.PRODUCT_VERSION }}.0"'
          '           Manufacturer="Sudoku Project"'
          '           UpgradeCode="${{ env.UPGRADE_CODE }}">'
          '    <Package InstallerVersion="200"'
          '             Compressed="yes"'
          '             InstallScope="perMachine"'
          '             Platform="x64" />'
          '    <Media Id="1" Cabinet="Sudoku.cab" EmbedCab="yes" />'
          ''
          '    <Directory Id="TARGETDIR" Name="SourceDir">'
          '      <Directory Id="ProgramFiles64Folder">'
          '        <Directory Id="INSTALLFOLDER" Name="Sudoku" />'
          '      </Directory>'
          '      <Directory Id="ProgramMenuFolder">'
          '        <Directory Id="ApplicationProgramsFolder" Name="Sudoku" />'
          '      </Directory>'
          '      <Directory Id="DesktopFolder" Name="Desktop" />'
          '    </Directory>'
          ''
          '    <DirectoryRef Id="INSTALLFOLDER">'
          $fileComponents
          '    </DirectoryRef>'
          ''
          '    <DirectoryRef Id="ApplicationProgramsFolder">'
          '      <Component Id="ApplicationShortcuts" Guid="' + (New-Guid) + '" Win64="yes">'
          '        <Shortcut Id="SudokuSolverShortcut" Name="Sudoku Solver (C++)" Target="[INSTALLFOLDER]SudokuSolver.exe"'
          '                 WorkingDirectory="INSTALLFOLDER" Description="Sudoku Solver" />'
          '        <Shortcut Id="SudokuSolverPyQT5Shortcut" Name="Sudoku Solver (PyQT5)" Target="[INSTALLFOLDER]SudokuSolver-PyQT5.exe"'
          '                 WorkingDirectory="INSTALLFOLDER" Description="Sudoku Solver PyQT5" />'
          '        <Shortcut Id="SudokuPuzzlerShortcut" Name="Sudoku Puzzler" Target="[INSTALLFOLDER]SudokuPuzzler.exe"'
          '                 WorkingDirectory="INSTALLFOLDER" Description="Sudoku Puzzler Game" />'
          '        <Shortcut Id="UninstallShortcut" Name="Uninstall Sudoku" Target="[SystemFolder]msiexec.exe"'
          '                 Arguments="/x [ProductCode]" Description="Uninstall Sudoku" />'
          '        <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall" />'
          '        <RegistryValue Root="HKCU" Key="Software\Sudoku" Name="installed" Type="integer" Value="1" KeyPath="yes" />'
          '      </Component>'
          '    </DirectoryRef>'
          ''
          '    <DirectoryRef Id="DesktopFolder">'
          '      <Component Id="DesktopShortcut" Guid="' + (New-Guid) + '" Win64="yes">'
          '        <Condition>DESKTOP_SHORTCUT</Condition>'
          '        <Shortcut Id="DesktopSudokuShortcut" Name="Sudoku Solver" Target="[INSTALLFOLDER]SudokuSolver.exe"'
          '                 WorkingDirectory="INSTALLFOLDER" Description="Sudoku Solver" />'
          '        <RegistryValue Root="HKCU" Key="Software\Sudoku" Name="desktop" Type="integer" Value="1" KeyPath="yes" />'
          '      </Component>'
          '    </DirectoryRef>'
          ''
          '    <Feature Id="ProductFeature" Title="Sudoku Solvers and Games" Level="1" ConfigurableDirectory="INSTALLFOLDER">'
          $componentRefs
          '      <ComponentRef Id="ApplicationShortcuts" />'
          '    </Feature>'
          ''
          '    <Feature Id="DesktopFeature" Title="Desktop Shortcut" Description="Create a desktop shortcut" Level="1000">'
          '      <ComponentRef Id="DesktopShortcut" />'
          '    </Feature>'
          ''
          '    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />'
          '    <Property Id="DESKTOP_SHORTCUT" Value="1" />'
          '    <UIRef Id="WixUI_FeatureTree" />'
          '    <UIRef Id="WixUI_ErrorProgressText" />'
          '  </Product>'
          '</Wix>'
        )
        
        $wxsLines | Out-File -FilePath "installer.wxs" -Encoding UTF8
        Write-Host "installer.wxs generated successfully"

    - name: Build MSI Installer
      working-directory: artifacts/build/windows
      shell: powershell
      run: |
        Write-Host "=== Building MSI Installer ==="
        Write-Host "Current directory: $(Get-Location)"
        Write-Host "Files:"
        Get-ChildItem
        
        # Compile with candle
        Write-Host "Compiling with candle.exe..."
        & candle.exe installer.wxs -o installer.wixobj -dSourceDir="$PWD"
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Candle failed with exit code $LASTEXITCODE"
          exit 1
        }
        
        # Link with light
        Write-Host "Linking with light.exe..."
        & light.exe -ext WixUIExtension installer.wixobj -o "Sudoku-${{ env.PRODUCT_VERSION }}.msi"
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Light failed with exit code $LASTEXITCODE"
          exit 1
        }
        
        # Verify
        if (Test-Path "Sudoku-${{ env.PRODUCT_VERSION }}.msi") {
          Write-Host "✅ MSI created successfully"
          $size = (Get-Item "Sudoku-${{ env.PRODUCT_VERSION }}.msi").Length / 1MB
          Write-Host "File size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Error "MSI file not created!"
          exit 1
        }

    - name: Create MSIX Package
      shell: powershell
      run: |
        # Create MSIX structure
        New-Item -ItemType Directory -Path "msix-package/Files" -Force | Out-Null
        New-Item -ItemType Directory -Path "msix-package/Assets" -Force | Out-Null
        
        # Copy application files
        Copy-Item "artifacts/build/windows/*.exe" "msix-package/Files/" -ErrorAction SilentlyContinue
        Copy-Item "artifacts/build/windows/*.dll" "msix-package/Files/" -ErrorAction SilentlyContinue
        Copy-Item "artifacts/build/windows/*.md" "msix-package/Files/" -ErrorAction SilentlyContinue
        
        # Create icon assets for Store
        Write-Host "Creating Microsoft Store assets..."
        $iconPath = "windows/appicon.jpg"
        if (-not (Test-Path $iconPath)) {
          Write-Host "Warning: appicon.jpg not found, MSIX will use placeholder"
        } else {
          # Install ImageMagick if needed
          if (-not (Get-Command magick -ErrorAction SilentlyContinue)) {
            choco install imagemagick.tool -y
          }
          
          # Create required asset sizes
          & magick "$iconPath" -resize 50x50 "msix-package/Assets/StoreLogo.scale-100.png"
          & magick "$iconPath" -resize 63x63 "msix-package/Assets/StoreLogo.scale-125.png"
          & magick "$iconPath" -resize 75x75 "msix-package/Assets/StoreLogo.scale-150.png"
          & magick "$iconPath" -resize 100x100 "msix-package/Assets/StoreLogo.scale-200.png"
          
          & magick "$iconPath" -resize 44x44 "msix-package/Assets/Square44x44Logo.scale-100.png"
          & magick "$iconPath" -resize 55x55 "msix-package/Assets/Square44x44Logo.scale-125.png"
          & magick "$iconPath" -resize 66x66 "msix-package/Assets/Square44x44Logo.scale-150.png"
          & magick "$iconPath" -resize 88x88 "msix-package/Assets/Square44x44Logo.scale-200.png"
          
          & magick "$iconPath" -resize 150x150 "msix-package/Assets/Square150x150Logo.scale-100.png"
          & magick "$iconPath" -resize 188x188 "msix-package/Assets/Square150x150Logo.scale-125.png"
          & magick "$iconPath" -resize 225x225 "msix-package/Assets/Square150x150Logo.scale-150.png"
          & magick "$iconPath" -resize 300x300 "msix-package/Assets/Square150x150Logo.scale-200.png"
          
          & magick "$iconPath" -resize 310x150 -background "#4682B4" -gravity center -extent 310x150 "msix-package/Assets/Wide310x150Logo.scale-100.png"
          & magick "$iconPath" -resize 388x188 -background "#4682B4" -gravity center -extent 388x188 "msix-package/Assets/Wide310x150Logo.scale-125.png"
          & magick "$iconPath" -resize 465x225 -background "#4682B4" -gravity center -extent 465x225 "msix-package/Assets/Wide310x150Logo.scale-150.png"
          & magick "$iconPath" -resize 620x300 -background "#4682B4" -gravity center -extent 620x300 "msix-package/Assets/Wide310x150Logo.scale-200.png"
          
          Write-Host "Store assets created successfully"
        }
        
        # Create AppxManifest
        @"
        <?xml version="1.0" encoding="utf-8"?>
        <Package xmlns="http://schemas.microsoft.com/appx/manifest/foundation/windows10"
                 xmlns:uap="http://schemas.microsoft.com/appx/manifest/uap/windows10"
                 xmlns:rescap="http://schemas.microsoft.com/appx/manifest/foundation/windows10/restrictedcapabilities">
          <Identity Name="SudokuProject.SudokuSolvers"
                    Version="${{ env.PRODUCT_VERSION }}.0"
                    Publisher="CN=9B3D6E7F-8E4C-4D5B-A6C7-D8E9F0A1B2C3"
                    ProcessorArchitecture="x64" />
          
          <Properties>
            <DisplayName>Sudoku Solvers</DisplayName>
            <PublisherDisplayName>Sudoku Project</PublisherDisplayName>
            <Description>Sudoku puzzle solvers and games</Description>
            <Logo>Assets\StoreLogo.scale-100.png</Logo>
          </Properties>
          
          <Dependencies>
            <TargetDeviceFamily Name="Windows.Desktop" MinVersion="10.0.17763.0" MaxVersionTested="10.0.22000.0" />
          </Dependencies>
          
          <Resources>
            <Resource Language="en-US"/>
          </Resources>
          
          <Capabilities>
            <rescap:Capability Name="runFullTrust" />
          </Capabilities>
          
          <Applications>
            <Application Id="SudokuSolver" Executable="Files\SudokuSolver.exe" EntryPoint="Windows.FullTrustApplication">
              <uap:VisualElements DisplayName="Sudoku Solver"
                                  Description="Sudoku puzzle solver"
                                  Square150x150Logo="Assets\Square150x150Logo.scale-100.png"
                                  Square44x44Logo="Assets\Square44x44Logo.scale-100.png"
                                  BackgroundColor="#4682B4">
                <uap:DefaultTile Wide310x150Logo="Assets\Wide310x150Logo.scale-100.png"
                                ShortName="Sudoku" />
                <uap:SplashScreen Image="Assets\Square150x150Logo.scale-100.png" />
              </uap:VisualElements>
            </Application>
            <Application Id="SudokuSolverPyQT5" Executable="Files\SudokuSolver-PyQT5.exe" EntryPoint="Windows.FullTrustApplication">
              <uap:VisualElements DisplayName="Sudoku Solver (PyQT5)"
                                  Description="Sudoku solver with PyQT5"
                                  Square150x150Logo="Assets\Square150x150Logo.scale-100.png"
                                  Square44x44Logo="Assets\Square44x44Logo.scale-100.png"
                                  BackgroundColor="#4682B4">
                <uap:DefaultTile ShortName="Sudoku PyQT5" />
              </uap:VisualElements>
            </Application>
            <Application Id="SudokuPuzzler" Executable="Files\SudokuPuzzler.exe" EntryPoint="Windows.FullTrustApplication">
              <uap:VisualElements DisplayName="Sudoku Puzzler"
                                  Description="Sudoku puzzle game"
                                  Square150x150Logo="Assets\Square150x150Logo.scale-100.png"
                                  Square44x44Logo="Assets\Square44x44Logo.scale-100.png"
                                  BackgroundColor="#4682B4">
                <uap:DefaultTile ShortName="Puzzler" />
              </uap:VisualElements>
            </Application>
          </Applications>
        </Package>
        "@ | Out-File -FilePath "msix-package/AppxManifest.xml" -Encoding UTF8
        
        Write-Host "AppxManifest created successfully"

    - name: Build MSIX Package
      shell: powershell
      run: |
        # Find MakeAppx
        $makeAppxPath = "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.22621.0\x64\makeappx.exe"
        
        if (-not (Test-Path $makeAppxPath)) {
          $sdkVersions = Get-ChildItem "${env:ProgramFiles(x86)}\Windows Kits\10\bin\" -Directory -ErrorAction SilentlyContinue | Where-Object { $_.Name -match "10\.0\.\d+\.\d+" } | Sort-Object Name -Descending
          if ($sdkVersions) {
            $makeAppxPath = Join-Path $sdkVersions[0].FullName "x64\makeappx.exe"
          }
        }
        
        if (-not (Test-Path $makeAppxPath)) {
          Write-Host "Warning: MakeAppx not found, skipping MSIX"
          exit 0
        }
        
        Write-Host "Building MSIX package..."
        & "$makeAppxPath" pack /d "msix-package" /p "Sudoku-${{ env.PRODUCT_VERSION }}.msix" /o
        
        if ($LASTEXITCODE -eq 0) {
          Write-Host "✅ MSIX created successfully"
          $size = (Get-Item "Sudoku-${{ env.PRODUCT_VERSION }}.msix").Length / 1MB
          Write-Host "File size: $([math]::Round($size, 2)) MB"
        } else {
          Write-Host "Warning: MSIX creation failed"
        }

    - name: Create Portable ZIP
      shell: powershell
      run: |
        $portableDir = "portable/Sudoku-${{ env.PRODUCT_VERSION }}"
        New-Item -ItemType Directory -Path $portableDir -Force | Out-Null
        
        Copy-Item "windows/x64/Release/SudokuSolver.exe" "$portableDir/" -ErrorAction SilentlyContinue
        Copy-Item "python_generate_puzzles/dist/SudokuSolver.exe" "$portableDir/SudokuSolver-PyQT5.exe" -ErrorAction SilentlyContinue
        Copy-Item "python_generate_puzzles/dist/SudokuPuzzler.exe" "$portableDir/" -ErrorAction SilentlyContinue
        Copy-Item "README.md" "$portableDir/" -ErrorAction SilentlyContinue
        Copy-Item "LICENSE.md" "$portableDir/" -ErrorAction SilentlyContinue
        
        Compress-Archive -Path $portableDir -DestinationPath "Sudoku-Portable-${{ env.PRODUCT_VERSION }}.zip"
        Write-Host "Portable ZIP created"

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sudoku-windows
        path: |
          artifacts/build/windows/Sudoku-*.msi
          Sudoku-*.msix
          Sudoku-Portable-*.zip

  create-release:
    needs: build-windows
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: github.event_name == 'push'
    
    steps:
    - name: Download MSI Artifact
      uses: actions/download-artifact@v4
      with:
        name: sudoku-windows
        path: release

    - name: Download MSDOS Artifact
      uses: actions/download-artifact@v4
      with:
        name: msdos-artifacts
        path: release

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          release/Sudoku-*.msi
          release/Sudoku-*.msix
          release/Sudoku-Portable-*.zip
          release/Sudoku-MSDOS.zip
        tag_name: ${{ github.ref == 'refs/heads/master' && format('v{0}', github.run_number) || format('dev-v{0}', github.run_number) }}
        name: ${{ github.ref == 'refs/heads/master' && format('Release {0}', github.run_number) || format('Dev Build {0}', github.run_number) }}
        draft: false
        prerelease: ${{ github.ref != 'refs/heads/master' }}
        body: |
          **Version:** ${{ needs.build-windows.outputs.version }}
          **Build:** #${{ github.run_number }}
          
          ## Downloads
          - **Sudoku-*.msi** - Windows installer with Start Menu shortcuts
          - **Sudoku-*.msix** - Microsoft Store package (unsigned, ready for Store submission)
          - **Sudoku-Portable-*.zip** - Portable version (no installation needed)
          - **Sudoku-MSDOS.zip** - MS-DOS version for retro systems (requires DOSBox)
          
          ## Features
          - Sudoku Solver (C++)
          - Sudoku Solver (PyQT5)
          - Sudoku Puzzler (PyQT5 Game)
          
          ## Silent Installation Support
          
          ### MSI Silent Install
          ```cmd
          # Silent install with all features
          msiexec /i Sudoku-*.msi /quiet /norestart DESKTOP_SHORTCUT=1
          
          # Silent install without desktop shortcut
          msiexec /i Sudoku-*.msi /quiet /norestart DESKTOP_SHORTCUT=0
          
          # Silent uninstall
          msiexec /x Sudoku-*.msi /quiet /norestart
          ```
          
          ### MSIX Silent Install (PowerShell)
          ```powershell
          # Silent install MSIX
          Add-AppxPackage -Path "Sudoku-*.msix" -ForceApplicationShutdown -ForceUpdateFromAnyVersion
          
          # Silent uninstall MSIX
          Remove-AppxPackage -Package "SudokuProject.SudokuSolvers_1.0.X_x64__9b3d6e7f8e4c4d5ba6c7d8e9f0a1b2c3"
          ```
          
          ### Enterprise Deployment
          Both MSI and MSIX support silent installation for enterprise environments:
          - **MSI**: Full PowerShell/cmd support with custom properties
          - **MSIX**: Windows 10+, requires PowerShell, supports Microsoft Store deployment
          
          Built with GitHub Actions
