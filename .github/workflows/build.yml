name: Build Sudoku

on:
  push:
    branches: [ master, dev ]
  pull_request:
    branches: [ master, dev ]
  workflow_dispatch:

env:
  PRODUCT_VERSION: "1.0.${{ github.run_number }}"

jobs:
  build-msdos:
    runs-on: ubuntu-latest
    container: 
      image: djfdyuruiry/djgpp
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        apt-get update
        apt-get install -y wget unzip zip

    - name: Download CSDPMI
      working-directory: msdos
      run: |
        wget http://na.mirror.garr.it/mirrors/djgpp/current/v2misc/csdpmi7b.zip
        unzip -o csdpmi7b.zip -d csdpmi

    - name: Build MS-DOS Version
      working-directory: msdos
      run: |
        cp ../shared/*.cpp .
        cp ../shared/*.h .
        g++ dosprint.cpp generatepuzzle.cpp msdos_main.cpp sudoku.cpp -o sudoku.exe
        exe2coff sudoku.exe
        cat csdpmi/bin/CWSDSTUB.EXE sudoku > sudoku.exe
        
    - name: Create MS-DOS Distribution
      working-directory: msdos
      run: |
        mkdir sudoku-msdos-v1.0
        cp sudoku.exe sudoku-msdos-v1.0/
        cp ../README.md sudoku-msdos-v1.0/
        cp ../LICENSE.md sudoku-msdos-v1.0/
        zip -r ../Sudoku-MSDOS.zip sudoku-msdos-v1.0

    - name: Upload MS-DOS Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: msdos-artifacts
        path: |
          Sudoku-MSDOS.zip
          msdos/sudoku.exe

  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    outputs:
      version: ${{ env.PRODUCT_VERSION }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.3.1
      
    - name: Setup Developer Command Prompt
      uses: ilammy/msvc-dev-cmd@v1

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install Python dependencies
      working-directory: python_generate_puzzles
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller pybind11

    - name: Build C++ Executable
      working-directory: windows
      run: |
        msbuild /p:Configuration=Release /p:Platform=x64 SudokuSolver.vcxproj

    - name: Build Python Extension
      working-directory: python_generate_puzzles
      run: |
        python setup.py build_ext --inplace --force

    - name: Create PyInstaller Spec for QT5 App Sudoku Solver
      working-directory: python_generate_puzzles
      shell: cmd
      run: |
        echo # -*- mode: python ; coding: utf-8 -*- > sudoku.spec
        echo. >> sudoku.spec
        echo block_cipher = None >> sudoku.spec
        echo. >> sudoku.spec
        echo a = Analysis( >> sudoku.spec
        echo     ['sudoku_game_qt5.py'], >> sudoku.spec
        echo     pathex=[], >> sudoku.spec
        echo     binaries=[], >> sudoku.spec
        echo     datas=[], >> sudoku.spec
        echo     hiddenimports=['PyQt5.sip'], >> sudoku.spec
        echo     hookspath=[], >> sudoku.spec
        echo     hooksconfig={}, >> sudoku.spec
        echo     runtime_hooks=[], >> sudoku.spec
        echo     excludes=[], >> sudoku.spec
        echo     win_no_prefer_redirects=False, >> sudoku.spec
        echo     win_private_assemblies=False, >> sudoku.spec
        echo     cipher=block_cipher, >> sudoku.spec
        echo     noarchive=False, >> sudoku.spec
        echo ) >> sudoku.spec
        echo. >> sudoku.spec
        echo a.binaries += [('sudoku_solver.pyd', './sudoku_solver.pyd', 'BINARY')] >> sudoku.spec
        echo. >> sudoku.spec
        echo pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher) >> sudoku.spec
        echo. >> sudoku.spec
        echo exe = EXE( >> sudoku.spec
        echo     pyz, >> sudoku.spec
        echo     a.scripts, >> sudoku.spec
        echo     a.binaries, >> sudoku.spec
        echo     a.zipfiles, >> sudoku.spec
        echo     a.datas, >> sudoku.spec
        echo     [], >> sudoku.spec
        echo     name='sudoku_solver_qt5_python', >> sudoku.spec
        echo     debug=False, >> sudoku.spec
        echo     bootloader_ignore_signals=False, >> sudoku.spec
        echo     strip=False, >> sudoku.spec
        echo     upx=True, >> sudoku.spec
        echo     upx_exclude=[], >> sudoku.spec
        echo     runtime_tmpdir=None, >> sudoku.spec
        echo     console=False, >> sudoku.spec
        echo     disable_windowed_traceback=False, >> sudoku.spec
        echo     target_arch=None, >> sudoku.spec
        echo     codesign_identity=None, >> sudoku.spec
        echo     entitlements_file=None, >> sudoku.spec
        echo ) >> sudoku.spec

    - name: Build Python Executable for QT5 Python Solver
      working-directory: python_generate_puzzles
      run: |
        pyinstaller --clean sudoku.spec

    - name: Create PyInstaller Spec for QT5 Sudoku Game
      working-directory: python_generate_puzzles
      shell: cmd
      run: |
        echo # -*- mode: python ; coding: utf-8 -*- > sudoku.spec
        echo. >> sudoku.spec
        echo block_cipher = None >> sudoku.spec
        echo. >> sudoku.spec
        echo a = Analysis( >> sudoku.spec
        echo     ['sudoku_player_qt5.py'], >> sudoku.spec
        echo     pathex=[], >> sudoku.spec
        echo     binaries=[], >> sudoku.spec
        echo     datas=[], >> sudoku.spec
        echo     hiddenimports=['PyQt5.sip'], >> sudoku.spec
        echo     hookspath=[], >> sudoku.spec
        echo     hooksconfig={}, >> sudoku.spec
        echo     runtime_hooks=[], >> sudoku.spec
        echo     excludes=[], >> sudoku.spec
        echo     win_no_prefer_redirects=False, >> sudoku.spec
        echo     win_private_assemblies=False, >> sudoku.spec
        echo     cipher=block_cipher, >> sudoku.spec
        echo     noarchive=False, >> sudoku.spec
        echo ) >> sudoku.spec
        echo. >> sudoku.spec
        echo a.binaries += [('sudoku_solver.pyd', './sudoku_solver.pyd', 'BINARY')] >> sudoku.spec
        echo. >> sudoku.spec
        echo pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher) >> sudoku.spec
        echo. >> sudoku.spec
        echo exe = EXE( >> sudoku.spec
        echo     pyz, >> sudoku.spec
        echo     a.scripts, >> sudoku.spec
        echo     a.binaries, >> sudoku.spec
        echo     a.zipfiles, >> sudoku.spec
        echo     a.datas, >> sudoku.spec
        echo     [], >> sudoku.spec
        echo     name='sudoku_puzzler', >> sudoku.spec
        echo     debug=False, >> sudoku.spec
        echo     bootloader_ignore_signals=False, >> sudoku.spec
        echo     strip=False, >> sudoku.spec
        echo     upx=True, >> sudoku.spec
        echo     upx_exclude=[], >> sudoku.spec
        echo     runtime_tmpdir=None, >> sudoku.spec
        echo     console=False, >> sudoku.spec
        echo     disable_windowed_traceback=False, >> sudoku.spec
        echo     target_arch=None, >> sudoku.spec
        echo     codesign_identity=None, >> sudoku.spec
        echo     entitlements_file=None, >> sudoku.spec
        echo ) >> sudoku.spec

    - name: Build Python Executable for QT5 Python Puzzler
      working-directory: python_generate_puzzles
      run: |
        pyinstaller --clean sudoku.spec

    - name: Convert Icon and Generate Variants
      shell: pwsh
      run: |
        if (-not (Get-Command magick -ErrorAction SilentlyContinue)) {
          choco install imagemagick.tool -y
        }
        magick convert "windows/appicon.jpg" -resize 256x256 -background none -gravity center -extent 256x256 "windows/appicon.png"
        New-Item -ItemType Directory -Path "windows/icon-variants" -Force | Out-Null
        foreach ($size in @("16x16", "24x24", "32x32", "48x48", "64x64", "128x128", "256x256")) {
          magick convert "windows/appicon.png" -resize $size "windows/icon-variants/icon-$size.png"
        }
        magick convert "windows/appicon.png" -define icon:auto-resize=256,128,96,64,48,32,16 "windows/appicon.ico"
        Write-Host "Icon processing complete"

    - name: Create Portable Zip Bundle
      shell: pwsh
      run: |
        $version = "${{ env.PRODUCT_VERSION }}"
        New-Item -ItemType Directory -Path "portable/Sudoku-Portable-$version" -Force | Out-Null
        Copy-Item "windows/x64/Release/SudokuSolver.exe" "portable/Sudoku-Portable-$version/"
        Copy-Item "python_generate_puzzles/dist/sudoku_solver_qt5_python.exe" "portable/Sudoku-Portable-$version/SudokuSolver-PyQT5.exe"
        Copy-Item "python_generate_puzzles/dist/sudoku_puzzler.exe" "portable/Sudoku-Portable-$version/SudokuPuzzler-PyQT5.exe"
        Copy-Item "README.md" "portable/Sudoku-Portable-$version/"
        Copy-Item "LICENSE.md" "portable/Sudoku-Portable-$version/"
        Compress-Archive -Path "portable/Sudoku-Portable-$version" -DestinationPath "Sudoku-Portable-$version.zip"
        Write-Host "Portable zip created"

    - name: Install WiX Toolset
      shell: pwsh
      run: |
        $wixUrl = "https://github.com/wixtoolset/wix3/releases/download/wix314rtm/wix314.exe"
        $wixExe = "$env:TEMP\wix314.exe"
        Write-Host "Downloading WiX Toolset..."
        [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
        Invoke-WebRequest -Uri $wixUrl -OutFile $wixExe
        Write-Host "Installing WiX Toolset from: $wixExe"
        & $wixExe /install /passive /quiet
        Start-Sleep -Seconds 15
        $wixPath = "C:\Program Files (x86)\WiX Toolset v3.14\bin"
        if (Test-Path $wixPath) {
          Write-Host "WiX installed successfully at $wixPath"
          Get-ChildItem $wixPath
        } else {
          Write-Host "Warning: WiX path not found, but continuing..."
        }

    - name: Create MSI Installer
      shell: pwsh
      run: |
        $msiDir = "msi-build"
        New-Item -ItemType Directory -Path $msiDir -Force | Out-Null
        Copy-Item "windows/x64/Release/SudokuSolver.exe" "$msiDir/"
        Copy-Item "python_generate_puzzles/dist/sudoku_solver_qt5_python.exe" "$msiDir/SudokuSolver-PyQT5.exe"
        Copy-Item "python_generate_puzzles/dist/sudoku_puzzler.exe" "$msiDir/SudokuPuzzler-PyQT5.exe"
        Copy-Item "README.md" "$msiDir/"
        Copy-Item "LICENSE.md" "$msiDir/"
        Write-Host "MSI build directory prepared"

    - name: Compile MSI with WiX
      shell: pwsh
      continue-on-error: true
      run: |
        $candleExe = "C:\Program Files (x86)\WiX Toolset v3.14\bin\candle.exe"
        $lightExe = "C:\Program Files (x86)\WiX Toolset v3.14\bin\light.exe"
        
        if (-not (Test-Path $candleExe)) {
          Write-Host "WiX Candle.exe not found at $candleExe"
          Write-Host "Attempting to find WiX installation..."
          $wixInstalls = Get-ChildItem "C:\Program Files (x86)" -Filter "*WiX*" -Directory -ErrorAction SilentlyContinue
          if ($wixInstalls) {
            $candleExe = Join-Path $wixInstalls[0].FullName "bin\candle.exe"
            $lightExe = Join-Path $wixInstalls[0].FullName "bin\light.exe"
            Write-Host "Found WiX at: $($wixInstalls[0].FullName)"
          } else {
            Write-Host "WiX not found. MSI will be skipped."
            exit 0
          }
        }
        
        if (-not (Test-Path $candleExe)) {
          Write-Host "Candle.exe still not found. Skipping MSI."
          exit 0
        }
        
        $wxsFile = "windows/Sudoku.wxs"
        if (-not (Test-Path $wxsFile)) {
          Write-Host "WiX source file not found at $wxsFile"
          exit 0
        }
        
        Write-Host "Using candle: $candleExe"
        Write-Host "Using light: $lightExe"
        
        $msiDir = "msi-build"
        New-Item -ItemType Directory -Path $msiDir -Force | Out-Null
        
        & $candleExe -arch x64 -o "$msiDir/Sudoku.wixobj" -dSourceDir="$PWD/msi-build" $wxsFile
        if ($LASTEXITCODE -eq 0) {
          & $lightExe -out "Sudoku-${{ env.PRODUCT_VERSION }}.msi" "$msiDir/Sudoku.wixobj" -ext WixUIExtension
          if ($LASTEXITCODE -eq 0) {
            Write-Host "MSI created successfully"
          } else {
            Write-Host "Light.exe failed"
          }
        } else {
          Write-Host "Candle.exe failed"
        }

    - name: Create MSIX Package
      shell: pwsh
      continue-on-error: true
      run: |
        $msixDir = "msix-package"
        New-Item -ItemType Directory -Path "$msixDir/Assets" -Force | Out-Null
        Copy-Item "windows/x64/Release/SudokuSolver.exe" "$msixDir/" -ErrorAction SilentlyContinue
        Copy-Item "python_generate_puzzles/dist/sudoku_solver_qt5_python.exe" "$msixDir/SudokuSolver-PyQT5.exe" -ErrorAction SilentlyContinue
        Copy-Item "python_generate_puzzles/dist/sudoku_puzzler.exe" "$msixDir/SudokuPuzzler-PyQT5.exe" -ErrorAction SilentlyContinue
        
        if (Test-Path "windows/icon-variants") {
          Copy-Item "windows/icon-variants/*" "$msixDir/Assets/" -Force
        }
        
        $manifestPath = "$msixDir/AppxManifest.xml"
        $manifestXml = "<?xml version=`"1.0`" encoding=`"utf-8`"?><Package xmlns=`"http://schemas.microsoft.com/appx/manifest/foundation/windows10`" xmlns:uap=`"http://schemas.microsoft.com/appx/manifest/uap/windows10`"><Identity Name=`"SudokuSolvers`" Publisher=`"CN=SudokuProject`" Version=`"1.0.0.0`" /><Properties><DisplayName>Sudoku Solvers</DisplayName><PublisherDisplayName>Sudoku Project</PublisherDisplayName><Logo>Assets\icon-256x256.png</Logo></Properties><Dependencies><TargetDeviceFamily Name=`"Windows.Desktop`" MinVersion=`"10.0.14393.0`" MaxVersionTested=`"10.0.19041.0`" /></Dependencies><Resources><Resource Language=`"en-US`" /></Resources><Applications><Application Id=`"SudokuSolver`" StartPage=`"SudokuSolver.exe`"><uap:VisualElements DisplayName=`"Sudoku Solver`" Square150x150Logo=`"Assets\icon-128x128.png`" Square44x44Logo=`"Assets\icon-48x48.png`" Description=`"Sudoku puzzle solver`" BackgroundColor=`"transparent`" /></Application><Application Id=`"SudokuSolverPyQT5`" StartPage=`"SudokuSolver-PyQT5.exe`"><uap:VisualElements DisplayName=`"Sudoku Solver PyQT5`" Square150x150Logo=`"Assets\icon-128x128.png`" Square44x44Logo=`"Assets\icon-48x48.png`" Description=`"Sudoku solver with PyQT5`" BackgroundColor=`"transparent`" /></Application><Application Id=`"SudokuPuzzler`" StartPage=`"SudokuPuzzler-PyQT5.exe`"><uap:VisualElements DisplayName=`"Sudoku Puzzler`" Square150x150Logo=`"Assets\icon-128x128.png`" Square44x44Logo=`"Assets\icon-48x48.png`" Description=`"Sudoku puzzle game`" BackgroundColor=`"transparent`" /></Application></Applications></Package>"
        $manifestXml | Out-File -FilePath $manifestPath -Encoding UTF8
        Write-Host "AppxManifest.xml created"
        
        $makeAppxPath = "${env:ProgramFiles(x86)}\Windows Kits\10\bin\10.0.22621.0\x64\makeappx.exe"
        if (-not (Test-Path $makeAppxPath)) {
          $sdkVersions = Get-ChildItem "${env:ProgramFiles(x86)}\Windows Kits\10\bin\" -Directory -ErrorAction SilentlyContinue | Where-Object { $_.Name -match "10\.0\.\d+\.\d+" } | Sort-Object Name -Descending
          if ($sdkVersions) {
            $makeAppxPath = Join-Path $sdkVersions[0].FullName "x64\makeappx.exe"
          }
        }
        
        if (Test-Path $makeAppxPath) {
          Write-Host "Using MakeAppx: $makeAppxPath"
          & "$makeAppxPath" pack /d "$msixDir" /p "Sudoku-${{ env.PRODUCT_VERSION }}.msix" /o
          if ($LASTEXITCODE -eq 0) {
            Write-Host "MSIX created successfully"
          } else {
            Write-Host "MakeAppx failed with exit code $LASTEXITCODE"
          }
        } else {
          Write-Host "MakeAppx.exe not found. MSIX will be skipped."
        }

    - name: Upload Windows Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-artifacts
        path: |
          windows/x64/Release/SudokuSolver.exe
          python_generate_puzzles/dist/sudoku_solver_qt5_python.exe
          python_generate_puzzles/dist/sudoku_puzzler.exe
          windows/appicon.png
          windows/appicon.ico
          windows/icon-variants
          Sudoku-Portable-*.zip
          Sudoku-*.msi
          Sudoku-*.msix

  build-gtk:
    runs-on: ubuntu-latest
    container: 
      image: fedora:latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        dnf -y update
        dnf -y install mingw64-gcc mingw64-gcc-c++ mingw64-gtk3 mingw64-gtkmm30 wine wine-devel wixl binutils zip

    - name: Build GTK Windows Version
      working-directory: gtk3
      run: |
        chmod +x ../shared/collect_dlls.sh
        mkdir -p build/windows_gtk3
        x86_64-w64-mingw32-g++ -std=c++11 -Wall -O2 \
          $(mingw64-pkg-config --cflags gtk+-3.0) \
          sudoku_game.cpp sudoku.cpp debug.cpp generatepuzzle.cpp \
          -o build/windows_gtk3/sudoku_game_gtk3.exe \
          $(mingw64-pkg-config --libs gtk+-3.0) -lstdc++ -mwindows

    - name: Collect DLLs for GTK Windows Version
      working-directory: gtk3
      run: |
        mkdir -p build/windows_gtk3
        ../shared/collect_dlls.sh build/windows_gtk3/sudoku_game_gtk3.exe \
          /usr/x86_64-w64-mingw32/sys-root/mingw/bin \
          build/windows_gtk3

    - name: Create ZIP Archive
      working-directory: gtk3
      run: |
        cp ../README.md build/windows_gtk3/
        cp ../LICENSE.md build/windows_gtk3/
        cd build/windows_gtk3
        zip -r ../../../Sudoku-GTK3-Windows.zip ./*

    - name: Upload GTK Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: gtk-artifacts
        path: Sudoku-GTK3-Windows.zip

  create-release:
    needs: [build-msdos, build-windows, build-gtk]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: github.event_name == 'push'
    
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          release-artifacts/msdos-artifacts/Sudoku-MSDOS.zip
          release-artifacts/msdos-artifacts/sudoku.exe
          release-artifacts/windows-artifacts/SudokuSolver.exe
          release-artifacts/windows-artifacts/sudoku_solver_qt5_python.exe
          release-artifacts/windows-artifacts/sudoku_puzzler.exe
          release-artifacts/windows-artifacts/Sudoku-Portable-*.zip
          release-artifacts/windows-artifacts/Sudoku-*.msi
          release-artifacts/windows-artifacts/Sudoku-*.msix
          release-artifacts/gtk-artifacts/Sudoku-GTK3-Windows.zip
        tag_name: ${{ github.ref == 'refs/heads/master' && format('v{0}', github.run_number) || format('bleedingedge-v{0}', github.run_number) }}
        name: ${{ github.ref == 'refs/heads/master' && format('Release {0}', github.run_number) || format('Dev Build {0}', github.run_number) }}
        draft: false
        prerelease: ${{ github.ref != 'refs/heads/master' }}
        body: |
          Version: ${{ needs.build-windows.outputs.version }}
          Commit: ${{ github.sha }}
          Build: #${{ github.run_number }}
          
          Includes: MS-DOS, Windows (C++/PyQT5), GTK3, MSI installer, MSIX package, and portable version.
